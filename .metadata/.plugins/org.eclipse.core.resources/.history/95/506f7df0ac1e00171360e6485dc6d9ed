/*
 * generated by Xtext 2.10.0
 */
package master.mdsd.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import master.mdsd.game.Character
import master.mdsd.game.Pathfinding
import master.mdsd.game.Object
import master.mdsd.game.Attack
import master.mdsd.game.Bullet
import java.util.Map
import master.mdsd.game.Entity
import master.mdsd.game.DynamicEntity
import master.mdsd.game.StaticEntity
import master.mdsd.game.GameMap
import master.mdsd.game.Initializer
import java.util.List
import master.mdsd.game.Behaviour
import master.mdsd.game.IntLiteral
import master.mdsd.game.Expression
import master.mdsd.game.Condition
import master.mdsd.game.BooleanExpression
import master.mdsd.game.Action

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class GameGenerator extends AbstractGenerator {
	
	private CharSequence all = ""

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {

		createAll(resource, fsa)
		
		fsa.generateFile('game.py',all)
	}
	
	def createAll(Resource resource, IFileSystemAccess2 fsa) {
		//fsa.generateFile('lib.py',addMaster())
		
		//all = addImport()
		
		//resource.allContents.filter(Character).forEach[createCharacter()]
		//resource.allContents.filter(Object).forEach[createObject()]
		//resource.allContents.filter(Pathfinding).forEach[createPathfinding()]
		//resource.allContents.filter(Attack).forEach[createAttack()]
		//resource.allContents.filter(Bullet).forEach[createBullet()]
		
		//all = all.toString() + addScript(resource)
		
		resource.allContents.filter(DynamicEntity).forEach[createEntityFile()]
		resource.allContents.filter(StaticEntity).forEach[createEntityFile()]
		
		
		fsa.generateFile('game.py', all)
	}
	
	def dispatch createEntityFile(StaticEntity entity){
			all = all.toString() + createEntity(entity)
	}
	
	def dispatch createEntityFile(DynamicEntity entity){
		all = all.toString() + createEntity(entity)
	}
	
	def dispatch createEntity(StaticEntity entity)'''
		class «entity.entityId»():
			«IF entity.entityId.equals('Map')»
			attributes = «createMap(entity as GameMap)»
			«ELSEIF entity.entityId.equals('Initializer')»
			attributes = «createInitializer(entity as Initializer)»
			«ENDIF»
			
	'''
	
	
	def Map createMap(GameMap gameMap){
		var Map attributes = newHashMap
			for(a : gameMap.attributeList){
				if(a.type.valueIdVec != null){
					attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
				}else{
					attributes.put(a.attributename, a.type.valueId)
				}
			}
		return attributes;
	}
	
	def Map createInitializer(Initializer init){
		var Map attributes = newHashMap
		var value = 0
			for(a : init.attributesInitializer){
				if(a.attributeId.equals('spawn')){
					if(a.amountValueId == 0){
						value = 1
					}else{
						value = a.amountValueId
					}
					var List locations = newArrayList
					locations.add(value)
					for(e : a.target.locationsId){
						if(e.locationId != null){
							locations.add(e.locationId)
						}else{
							locations.add(#[e.typea.valueId, e.typeb.valueId])
						}
					}
					attributes.put(a.target.targetId, locations)
				}
			}
			
		return attributes;
	}
	
	def dispatch createEntity(DynamicEntity entity)'''
		class «entity.name»():
			«IF entity.entityid.equals('Character')»
			attributes = «createCharacter(entity as Character)»
			«ELSEIF entity.entityid.equals('Object')»
			attributes = «createObject(entity as Object)»
			«ELSEIF entity.entityid.equals('Pathfinding')»
			attributes = «createPathfinding(entity as Pathfinding)»
			
			def pathfinding():
				«createPathfindingFunc(entity as Pathfinding)»
			«ELSEIF entity.entityid.equals('Attack')»
			attributes = «createAttack(entity as Attack)»
			«ELSEIF entity.entityid.equals('Bullet')»
			attributes = «createBullet(entity as Bullet)»
			«ENDIF»
			
	'''
	
	def Map createCharacter(Character character){
		var Map attributes = newHashMap
		for(a:character.att){
			if(a.type.valueIdVec != null){
				attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
			}else{
				attributes.put(a.attributename, a.type.valueId)
			}
		}
		return attributes;
	}
	
	def Map createObject(Object object){
		var Map attributes = newHashMap
		for(a:object.att){
			if(a.type.valueIdVec != null){
				attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
			}else{
				attributes.put(a.attributename, a.type.valueId)
			}
		}
		return attributes;
	}
	
	def Map createPathfinding(Pathfinding pathfinding){
		var Map attributes = newHashMap
		for(a:pathfinding.attPathfinding){
			if(a.type.valueIdVec != null){
				attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
			}else{
				attributes.put(a.attributename, a.type.valueId)
			}
		}
		return attributes;
		
		/* 
		FOR ruleSet : pathfinding.ruleSets
			def checkCondition():
				if ruleSet.rule.ruleSetup.attributeRefLeft.ruleSet.rule.ruleSetup.ruleType ruleSet.rule.ruleSetup.operator ruleSet.rule.ruleSetup.intAttleft:
					self.«ruleSet.rule.toDoAction.charAtt = ruleSet.rule.toDoAction.charDec ruleSet.rule.toDoAction.lo
			ENDFOR
			*/
	}
	
	def Map createAttack(Attack attack){
		var Map attributes = newHashMap
				for(a:attack.attributes){
					if(a.type.valueIdVec != null){
						attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
					}else{
						attributes.put(a.attributename, a.type.valueId)
					}
				}
				return attributes;
	}
	
	def Map createBullet(Bullet bullet){
		var Map attributes = newHashMap
				for(a:bullet.attributesBullet){
					if(a.type.valueIdVec != null){
						attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
					}else{
						attributes.put(a.attributename, a.type.valueId)
					}
				}
				return attributes;
	}
	
	def createPathfindingFunc(Pathfinding pathfinding)'''
		«FOR con : pathfinding.conditions»
		«ifHelper(con)»:
			«conAction(con.then)»
		«ENDFOR»
	'''
	
	def List<String> ifHelper(Condition con){
		var ifsList = newArrayList
		var ifs = 'if '+ ifHelper2(con.ifCondition)
		ifs = ifs.substring(0,ifs.length-1)
		ifsList.add(ifs)
		for(elif : con.elseIfCondition){
			
		}
		return ifsList
	}
	
	def String conAction(Action action){
		var returnString = ''
		var isReference = false
		
		if(action.charAtt.reference.characterId != null){
			returnString = returnString+action.charAtt.reference.characterId.name+'.'
		}
		else if(action.charAtt.reference.targetId != null){
			returnString = returnString + action.charAtt.reference.targetId+'.'
		}
		returnString = returnString + 'attributes[' + action.charAtt.attributename+'] = '
		if(action.charDec !=null){
			if(action.charDec.^val != null){
				returnString = returnString + action.charDec.^val
			}
			else if(action.charDec.charAttResult.reference.characterId.name != null){
				returnString = returnString + action.charDec.charAttResult.reference.characterId.name+'.'
				isReference = true
			}
			else if(action.charDec.charAttResult.reference.targetId != null){
				returnString = returnString + action.charDec.charAttResult.reference.targetId+'.'
				isReference = true
			}
			if(isReference){
				returnString = returnString + 'attributes[' + action.charDec.charAttResult.attributename+'] '
			}
			if(action.op != null){
				returnString = returnString + action.op + ' '
			}
			returnString = returnString  + expression(action.lo)
			
		}
		
		
		
		return returnString
	}
	
	def String ifHelper2(BooleanExpression boo){
		var condition = ''
		if(boo.attributeRefLeft !=null){
			if(boo.attributeRefLeft.reference.characterId != null){
				condition = condition+boo.attributeRefLeft.reference.characterId.name+'.'
			}
			if(boo.attributeRefLeft.reference.targetId != null){
				condition = condition+boo.attributeRefLeft.reference.targetId+'.'
			}
			condition = condition+boo.attributeRefLeft.attributename+' '
		}
		if(boo.leftEx !=null){
			condition = condition + expression(boo.leftEx)+' '
		}
		condition = condition + boo.operator.op + ' '
		if(boo.attributeRefRight !=null){
			if(boo.attributeRefRight.reference.characterId != null){
				condition = condition + boo.attributeRefRight.reference.characterId.name + '.'
			}
			if(boo.attributeRefRight.reference.targetId != null){
				condition = condition + boo.attributeRefRight.reference.targetId + '.'
			}
			condition = condition + boo.attributeRefRight.attributename + ' '
		}
		if(boo.rightEx !=null){
			if(boo.op != null){
				condition = condition + boo.op.lop + ' '
			}
			condition = condition + expression(boo.rightEx)
		}
		
		return condition
	}
	
	def dispatch expression(Expression i)'''
		«expression(i.tm)»
	'''
	
	def dispatch expression(IntLiteral i)'''
		«i.value»
	'''

	
	/* 
	
	def createPathfinding(Pathfinding pathfinding) {
		all = all.toString() + addPathfinding(pathfinding)
	}
	
	def createAttack(Attack attack) {
		all = all.toString() + addAttack(attack)
	}
	
	def createBullet(Bullet bullet) {
		all = all.toString() + addBullet(bullet)
	}
	
	def createCharacter(Character character) {
		all = all.toString() + addCharacter(character)
	}
	
	def createObject(Object object) {
		all = all.toString() + addObject(object)
	}
	
	
	
	def addImport()'''
		from lib import *
		
	'''
	
	def addPathfinding(Pathfinding pathfinding)'''
		class «pathfinding.name»():
		«/*»
			«FOR ruleSet : pathfinding.ruleSets»
			def checkCondition():
				if «ruleSet.rule.ruleSetup.attributeRefLeft».«ruleSet.rule.ruleSetup.ruleType» «ruleSet.rule.ruleSetup.operator» «ruleSet.rule.ruleSetup.intAttleft»:
					self.«ruleSet.rule.toDoAction.charAtt» = «ruleSet.rule.toDoAction.charDec»«ruleSet.rule.toDoAction.lo»
			«ENDFOR»
			
			
	'''
	
	def addAttack(Attack attack)'''
		class «attack.name»():
		
	'''
	
	def addBullet(Bullet bullet)'''
		class «bullet.name»():
			
		
	'''
	
	def addCharacter(Character character) '''
		class «character.name»():
			attr = «attrToCharacter(character)»
		
	'''
	
	def Map attrToCharacter(Character character){
		var Map attributes = newHashMap
			for(a : character.att){
				if(a.type.valueIdVec != null){
					attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
				}else{
					attributes.put(a.attributename, a.type.valueId)
				}
			}
		return attributes;
	}
	
	def addObject(Object object)'''
		class «object.name»():
		
	'''
	
	def addScript(Resource resource)'''
		player = «»(«attrToCharacter(resource, 'Player')»)
	'''
	
	def Map attrToCharacter(Resource resource, String type){
		var Map attributes = newHashMap
		for (e : resource.allContents.filter(Character).toIterable()){
			if (e.charId.charTypeId.equals('Player')){
				for(a:e.att){
					if(a.type.valueIdVec != null){
						attributes.put(a.attributename, #[a.type.valueIdVec.XVal, a.type.valueIdVec.YVal])
					}else{
						attributes.put(a.attributename, a.type.valueId)
					}
				}
			}
		}
		return attributes;
	}
	
	
	// «IF ruleSet.rule.ruleSetup.attributeRefLeft != null»«»«ENDIF»
	*/
}
